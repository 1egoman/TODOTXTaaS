<html>
  <head>
    <title>lists</title>
  </head>
  <body ng-app="listsapp">

    <div ng-controller="listsController">
      <h1>TODOTXTaaS</h1>
      (projects and contexts are comma seperated)
      <a href="/todo.txt" target="_blank">todo.txt</a>
      <ul>
        <li ng-repeat="d in all">
          <input type="checkbox" ng-model="d.complete" ng-change="markItem(d)" />

          <div style="width: 75px; display: inline-block;">{{d.complete && formatDate(d.date)}}</div>

          <input type="text" ng-model="d.text" ng-change="updateItem(d)" />

          @<input type="text" ng-model="d.contexts" ng-change="updateItem(d)" />

          +<input type="text" ng-model="d.projects" ng-change="updateItem(d)" />

        </li>
      </ul>

      <input type="text" ng-model="newItem"/>
      <button ng-click="makeNew(newItem)">new</button>

      <p>
        Data visualization here
        <br/>
        completed: d.complete && d.date
      </p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.3.15/angular.min.js"></script>
    <script>
    lists = angular.module("listsapp", {})
    lists.controller("listsController", function($http, $scope) {

      $scope.stringify = function(a) {
        return JSON.stringify(a)
      }

      $scope.formatDate = function(d) {
        console.log(new Date(d).toISOString().substring(0, 10))
        return new Date(d).toISOString().substring(0, 10)
      }

      $scope.get = function() {
        $http({
          "method": "get",
          "url": "/items"
        }).success(function(data) {
          $scope.all = data.data;
        });
      };
      $scope.get();

      $scope.makeNew = function(n) {
        $http({
          "method": "post",
          "url": "/items",
          "data": {data: n}
        }).success(function(d) {
          console.log("cool")
          $scope.get();
        });

        setTimeout(function() {
          location.reload();
        },1500)
      };

      $scope.updateItem = function(d) {
        if (typeof d.contexts === "string") {
          d.contexts = d.contexts.split(",")
        }
        if (typeof d.projects === "string") {
          d.projects = d.projects.split(",")
        }
        console.log(d)

        $http({
          method: "put",
          url: "/items/"+d._id,
          data: d
        }).success(function(d) {
          console.log("update", d)
        });
      };

      $scope.markItem = function(d) {
        d.date = (new Date()).toString()
        $http({
          method: "put",
          url: "/items/"+d._id,
          data: {complete: d.complete}
        }).success(function(d) {
          console.log("update", d)
        });
      };


    })
    </script>
  </body>
</html>
